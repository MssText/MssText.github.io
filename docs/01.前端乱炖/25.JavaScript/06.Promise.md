---
title: Promise
date: 2021-05-17 21:17:57
permalink: /pages/c4e0c3/
categories:
  - å‰ç«¯ä¹±ç‚–
  - JavaScript
tags:
  - 
---
### å‰è¨€

> è¯´åˆ°promiseçš„å‡ºçŽ°ï¼Œæˆ‘ä»¬å…ˆå¾—çœ‹çœ‹æˆ‘ä»¬ä¸ºä»€ä¹ˆä¼šä½¿ç”¨å›žè°ƒå‡½æ•°ï¼šè€ƒè™‘è¿™æ ·çš„åº”ç”¨åœºæ™¯ï¼Œå½“æˆ‘ä»¬çš„å‡½æ•°ä¸­å…·æœ‰å¼‚æ­¥æ“ä½œæ—¶ï¼Œæˆ‘ä»¬å¦‚ä½•ç›‘å¬è¿™ä¸ªå¼‚æ­¥æ“ä½œå‘¢ï¼Ÿåˆç†çš„æƒ…å†µæ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åŒæ—¶ç›‘å¬å¼‚æ­¥æ“ä½œçš„æˆåŠŸå’Œå¤±è´¥ï¼Œå¹¶ä¸”å¯¹å¼‚æ­¥æ“ä½œçš„æˆåŠŸæˆ–è€…å¤±è´¥å…·æœ‰å“åº”èƒ½åŠ›æˆ–è€…è¯´æŽ§åˆ¶æƒã€‚ä½†æ˜¯å½“æˆ‘ä»¬çš„å¼‚æ­¥æ“ä½œå¾ˆå¤šï¼Œå¹¶ä¸”è¦æ±‚æŽ§åˆ¶æ¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„æ‰§è¡Œé¡ºåºï¼Œå°±éš¾å…ä¼šå®šä¹‰å¾ˆå¤šçš„å›žè°ƒå‡½æ•°ï¼ŒåŒæ—¶ä¸ºäº†æŽ§åˆ¶é¡ºåºï¼Œä¹Ÿä¼šåµŒå¥—å›žè°ƒå‡½æ•°ï¼Œå½“å›žè°ƒå‡½æ•°çš„å±‚çº§å¾ˆæ·±çš„æ—¶å€™ï¼Œå°±ä¼šäº§ç”Ÿæ‰€è°“çš„å›žè°ƒåœ°ç‹±ï¼Œè€Œpromiseçš„å‡ºçŽ°æ­£æ˜¯ä¸ºäº†è§£å†³è¿™ç§å›°å¢ƒã€‚

### ä¸€ã€promiseçš„ç®€å•ä»‹ç»

> æ­£å¦‚å…¶æ„ï¼Œpromiseè¡¨ç¤ºæ‰¿è¯ºçš„æ„æ€ã€‚promiseå¯ä»¥ç±»æ¯”ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œç”Ÿäº§è€…å¯¹æ¶ˆè´¹è€…æ‰¿è¯ºä¸€æ‰¹å•†å“ï¼Œæ¶ˆè´¹è€…é€šè¿‡ä»¥æŸç§æ–¹å¼å’Œç”Ÿäº§è€…è¿›è¡Œè¿žæŽ¥ï¼Œå¹¶ä½¿ç”¨ä¹‹å‰è§„å®šå¥½çš„æ–¹å¼æ¶ˆè´¹ç”Ÿäº§è€…ç”Ÿäº§çš„å•†å“ã€‚ç”Ÿäº§è€…åªéœ€è¦å»ºç«‹è¿™ç§è”ç³»ï¼Œå°†å•†å“ç»™åˆ°æ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹çš„æ—¶å€™ï¼Œå•†å“æˆ–å¥½æˆ–åï¼Œä¸¤ç§ç»“æžœä¸‹æ¶ˆè´¹è€…ä¼šæœ‰ä¸åŒçš„å¤„ç†ï¼Œä½†æ˜¯å•†å“çš„çŠ¶æ€æ˜¯ä¸å¯é€†çš„ï¼Œå¯èƒ½æ˜¯å¥½ä¸œè¥¿æˆ–è€…æ˜¯æ®‹æ¬¡å“ã€‚åŒæ—¶åŒä¸€ä¸ªå•†å“ä¸èƒ½åŒæ—¶æ˜¯å­˜åœ¨ä¸¤ç§çŠ¶æ€ï¼Œå¥½ä¸œè¥¿å’Œæ®‹æ¬¡å“åº”è¯¥æ˜¯äº’æ–¥çš„ã€‚

é¦–å…ˆæ¥çœ‹çœ‹ç”Ÿäº§è€…-promiseæž„é€ å‡½æ•°

```js
let promise = new Promise (function (resolve, reject) {
  // è¿™å°±æ˜¯ç”Ÿäº§è€…ç”Ÿäº§çš„å•†å“
})
```

å…¶ä¸­ï¼Œä¼ å…¥promiseæž„é€ å‡½æ•°çš„å‡½æ•°è¢«ç§°ä½œ**executor**ï¼Œè¿™å°±æ˜¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å»ºç«‹è”ç³»çš„æ–¹å¼ï¼Œé€šè¿‡å‘promiseæž„é€ å‡½æ•°ä¸­ä¼ å…¥executorã€‚æ¯ä¸€ä¸ªexecutoréƒ½æœ‰ä¸¤ä¸ªå›žè°ƒçš„å‡½æ•°ï¼Œè¿™æ˜¯JSå¼•æ“Žå†…ç½®çš„ä¸¤ä¸ªå›žè°ƒå‡½æ•°ï¼Œä¸ç”¨æˆ‘ä»¬è‡ªå·±å®šä¹‰ã€‚

> - resolve(value)  å¦‚æžœä»»åŠ¡æˆåŠŸå°±è¿”å›žvalue
> - reject(error)    å¦‚æžœä»»åŠ¡æ‰§è¡Œå¤±è´¥ å¹¶ä¸”æœ‰errorï¼Œå°±è¿”å›žerrorå¯¹è±¡

ç®€å•æ¥è¯´ï¼Œexecutorä¼šæ‰§è¡ŒæŸä¸ªä»»åŠ¡ï¼Œæ‰§è¡Œæ—¶é—´æˆ‘ä»¬å¹¶ä¸å…³å¿ƒï¼Œä»»åŠ¡æ‰§è¡ŒæˆåŠŸæˆ‘ä»¬å°±è°ƒç”¨resolveï¼Œä»»åŠ¡æ‰§è¡Œå¤±è´¥æˆ‘ä»¬å°±æ‰§è¡Œrejectã€‚

å¯¹äºŽï¼Œnew promiseæž„é€ å‡½æ•°è¿”å›žçš„å¯¹è±¡å…·æœ‰è¿™ä¸ªå±žæ€§ï¼Œæ–¹ä¾¿æˆ‘ä»¬è·Ÿè¸ªä»»åŠ¡çš„è¿›è¡ŒçŠ¶æ€:

> - state: æœ€å¼€å§‹æ˜¯pending,è¡¨ç¤ºè¿™æ˜¯åœ¨ç­‰å¾…çŠ¶æ€ï¼›å½“ä»»åŠ¡æ‰§è¡ŒæˆåŠŸåŽï¼Œè°ƒç”¨resolveå‡½æ•°ï¼Œstateä¼šå˜æˆfulfilled;ä»»åŠ¡æ‰§è¡Œå¤±è´¥åŽï¼Œè°ƒç”¨rejectå‡½æ•°ï¼Œstateä¼šå˜æˆrejectedã€‚
> - result: æœ€å¼€å§‹æ˜¯undefined,è°ƒç”¨resolve(value)çš„æ—¶å€™å˜æˆvalue, æˆ–è€…åœ¨è°ƒç”¨reject(erroe)çš„æ—¶å€™å˜æˆerrorã€‚

#### 1.æ­£å¦‚å‰é¢æåˆ°çš„åŒä¸€ä¸ªå•†å“åªèƒ½æœ‰ä¸€ä¸ªè¯„ä»·ï¼Œstateçš„çŠ¶æ€åªèƒ½æ˜¯ä¸€ç§ï¼š

```js
// è¿™é‡Œçš„å®—æ—¨æ˜¯ï¼šåªèƒ½æ˜¯resolveæˆ–è€…reject,ä¸”åªèƒ½å­˜åœ¨ä¸€ä¸ªã€‚
let promise = new Promise(function(resolve, reject) {
  resolve("done");

  reject(new Error("â€¦")); // è¢«å¿½ç•¥
  setTimeout(() => resolve("â€¦")); // è¢«å¿½ç•¥
});
```

ii. å¦‚æžœexecutorå‡ºçŽ°äº†ä»€ä¹ˆé”™è¯¯ï¼Œexecutorä¼šç«‹å³è°ƒç”¨rejectå‡½æ•°ï¼Œä¼ å…¥rejectçš„å‚æ•°å¯ä»¥æ˜¯ä»»ä½•å€¼ï¼Œä½†æ˜¯æŽ¨èä½¿ç”¨Errorå¯¹è±¡ï¼Œæ›´å¥½çš„ä½“çŽ°äº†executorå‘ç”Ÿäº†é”™è¯¯ã€‚

iii. resolveå’Œrejectå¯ä»¥ç«‹å³è°ƒç”¨ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œéƒ½æ˜¯ç­‰å¾…executorè¿è¡Œçš„ç»“æžœï¼Œç„¶åŽè‡ªåŠ¨è°ƒç”¨resolveå’Œrejectè¿™ä¸¤ä¸ªå›žè°ƒå‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä¹ˆä¹Ÿå¯ä»¥æ˜¾ç¤ºçš„è°ƒç”¨resolveå’Œreject

```js
let promise = new Promise(function(resolve, reject) {
  resolve("done");
});
```

å†æ¥çœ‹æ¶ˆè´¹è€…æ˜¯å¦‚ä½•æ¶ˆè´¹çš„

> æ¶ˆè´¹è€…æŽ¥å—å•†å“çš„æ–¹å¼ä¸»è¦æ˜¯ä¸‰ç§ï¼šthenã€catchã€finally

#### 2.then

```js
let promise = new Promise(function(resolve, reject) {
    // å½“ promise è¢«æž„é€ å®Œæˆæ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œæ­¤å‡½æ•°
    setTimeout(() => resolve("è¿™ä¸ªä»»åŠ¡æ‰§è¡ŒæˆåŠŸäº†ï¼ï¼"), 1000);
  });

  promise.then((result) => {
      console.log(result); // 1ç§’åŽ è¿™ä¸ªä»»åŠ¡æ‰§è¡ŒæˆåŠŸäº†ï¼ï¼
  })
```

æ¶ˆè´¹è€…å¯ä»¥è¿™æ ·æŽ¥æ”¶è´¨é‡ä¸Šä¹˜çš„å•†å“ï¼Œä½†æ˜¯é‡åˆ°æ®‹æ¬¡å“å‘¢ï¼Ÿæˆ‘ä»¬å¾—è¿™æ ·ï¼š

```js
let promise = new Promise(function(resolve, reject) {
    // å½“ promise è¢«æž„é€ å®Œæˆæ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œæ­¤å‡½æ•°
    setTimeout(() => reject(new Error("ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼ï¼")), 1000);
  });

  promise.then((err) => {
      console.log(err); // Error: ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼ï¼
  })
```

thenæ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‡½æ•°æ˜¯æŽ¥æ”¶executoræ‰§è¡ŒæˆåŠŸåŽçš„ç»“æžœï¼Œç¬¬äºŒä¸ªå‡½æ•°æ˜¯æŽ¥æ”¶executoræ‰§è¡Œå¤±è´¥åŽçš„ç»“æžœã€‚

```js
let promise = new Promise(function(resolve, reject) {
    // å½“ promise è¢«æž„é€ å®Œæˆæ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œæ­¤å‡½æ•°
  });

  promise.then((result) => {
      console.log(result);
  },(err) => {
      console.log(err); 
  })
```

#### 3.catch

åœ¨ä¸Šé¢è¯´åˆ°å½“stateå˜ä¸ºrejectedçš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨then(null,rejection)æˆ–then(undefined, rejection)æ•æ‰é”™è¯¯,ä½†æ˜¯promiseç»™æˆ‘ä»¬æä¾›äº†æ›´åŠ ä¼˜é›…çš„æ•æ‰é”™è¯¯çš„åšæ³•ï¼Œå°±æ˜¯ä½¿ç”¨catch,å¦‚ä¸‹é¢çš„ðŸŒ°:

```js
let promise = new Promise(function(resolve, reject) {
    // å½“ promise è¢«æž„é€ å®Œæˆæ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œæ­¤å‡½æ•°
    setTimeout(() => reject(new Error("ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼ï¼")), 1000);
  });

  promise.catch(console.log) // Error: ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼ï¼
```

#### 4.finally

ä¸ç®¡executoræ‰§è¡Œçš„ç»“æžœæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œæ€»æœ‰ä¸€äº›æƒ…å†µæ˜¯éƒ½ä¼šå¤„ç†çš„ï¼Œæ¯”å¦‚æ¸…ç†ä¸ç”¨å¤šå˜é‡ï¼Œè¿™ä¸ªæ—¶å€™å°±è¦ç”¨åˆ°finally:

```js
let promise = new Promise(function(resolve, reject) {
    // å½“ promise è¢«æž„é€ å®Œæˆæ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œæ­¤å‡½æ•°
    setTimeout(() => reject(new Error("ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼ï¼")), 1000);
  });

  promise.finally().then(null,(err) => {
      console.log(err);
  })
```

è¿™é‡Œfinallyæ˜¯å°†æ‰§è¡Œçš„ç»“æžœè¿›è¡Œä¼ é€’ï¼Œè¿”å›žä¹Ÿæ˜¯ä¸€ä¸ªpromiseï¼Œå¯ä»¥ä½¿ç”¨thenæ–¹æ³•è¿›è¡ŒæŽ¥æ”¶ã€‚

### äºŒã€å¯¹promiseçš„ç®€å•å®žçŽ°

ä¸€ä¸ªå®Œç¾Žçš„promiseåº”è¯¥ç¬¦åˆ[promise A+è§„èŒƒ](httpshttps://malcolmyu.github.io/2015/06/12/Promises-A-Plus/#://malcolmyu.github.io/2015/06/12/Promises-A-Plus/#)ï¼Œè¯¥è§„èŒƒè¯¦å°½æè¿°äº†promiseçš„å„ç§è¡Œä¸ºï¼Œæˆ‘ä»¬å…ˆæ¥å®žçŽ°ä¸€ä¸ªç®€æ˜“ç‰ˆçš„promiseï¼Œç®€æ˜“ç‰ˆç¬¦åˆä¸‹é¢çš„è¦æ±‚:

> - å½“new MyPromiseæž„é€ å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œç«‹å³æ‰§è¡Œä¼ å…¥çš„å‡½æ•°executor
> - è‡ªå®šä¹‰çš„MyPromiseç±»æœ‰ä¸‰ç§çŠ¶æ€ï¼Œpendingã€fulfilledã€rejectedä¸‰ç§çŠ¶æ€ï¼Œåˆå§‹çŠ¶æ€éƒ½æ˜¯pendingã€‚executoræœ‰ä¸¤ä¸ªå›žè°ƒå‡½æ•°å‚æ•°ï¼Œresolveå’Œrejectï¼›å½“executoræ‰§è¡Œæ—¶ï¼Œè°ƒç”¨resolveï¼ŒMyPromiseç±»çš„stateæ˜¯fulfilled;è°ƒç”¨rejectï¼Œstateå˜ä¸ºrejected
> - å­˜åœ¨ä¸€ä¸ªthenæ–¹æ³•ï¼Œä¹Ÿæœ‰ä¸¤ä¸ªå›žè°ƒå‚æ•°ï¼ŒonFulfilledå’ŒonRejected;å½“onFulfilledä¸æ˜¯å‡½æ•°æ—¶ï¼Œç›´æŽ¥è¿”å›žonFulfilledçš„å€¼ï¼›å½“onRejectedä¸æ˜¯å‡½æ•°æ—¶ï¼Œç›´æŽ¥è¿”å›žåŽŸå› ã€‚å½“onFulfilledå’ŒonRejectedéƒ½æ˜¯å‡½æ•°æ—¶ï¼Œè‹¥æ˜¯stateæ—¶fulfilledæ—¶ï¼Œç›´æŽ¥è°ƒç”¨onFulfilledï¼›å½“stateæ˜¯rejectedæ—¶ï¼Œç›´æŽ¥è°ƒç”¨onRejectedã€‚

```js
// ç®€æ˜“ç‰ˆpromise

// å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼šåˆ¤æ–­ä¼ å…¥çš„å˜é‡æ˜¯å¦æ˜¯å‡½æ•°
const isFunction = variable => typeof variable === 'function';

// å®šä¹‰Promiseçš„ä¸‰ç§çŠ¶æ€: pendingã€fulfilledã€rejected

const PENDING = 'pending'
const FULFILLED = 'fulfilled'
const REJECTED = 'rejected'

// å®šä¹‰ä¸€ä¸ªè‡ªå·±çš„Promiseç±»
class MyPromise {
    constructor(executor) {
        if (!isFunction(executor)) {
            return new Error("å¤§å…„å¼Ÿï¼Œä¼ å…¥çš„ä¸æ˜¯å‡½æ•°ï¼ï¼")
        }

        this._state = PENDING; // åˆå§‹çŠ¶æ€
        this._value = null; //æˆåŠŸè¿”å›žçš„å€¼
        this._reason = null; //å¤±è´¥è¿”å›žçš„åŽŸå› 

        try {
            // æž„é€ å‡½æ•°æ‰§è¡Œå®Œæˆï¼Œç«‹å³æ‰§è¡Œexecutorå‡½æ•°(æ³¨æ„ï¼Œéœ€è¦ä½¿ç”¨bindç»‘å®šthisçš„ä¸Šä¸‹æ–‡)
            executor(this._resolve.bind(this), this._reject.bind(this))
        } catch (err) {
           this._reject(err)
        }
    }

    // resolveå‡½æ•°
    _resolve (val) {
        if (this._state !== PENDING) return;
        this._state = FULFILLED;
        this._value = val;
    }

    //  rejectå‡½æ•°
    _reject (err) {
        if (this._state !== PENDING) return;
        this._state = REJECTED;
        this._reason = err;
    }
}

// å®žçŽ°thenæ–¹æ³•
MyPromise.prototype.then = function(onFulfilled, onRejected) {

    let realOnFulfilled = onFulfilled;
    let realOnRejected = onRejected;

    if (!isFunction(realOnFulfilled)) {
        realOnFulfilled = function (value) {
            return value;
        }
    }

    if (!isFunction(realOnRejected)) {
        realOnRejected = function (reason) {
            if (reason instanceof Error) {
                return reason;
            } else {
                throw new Error(reason)
            }
        }
    }

    // promiseçŠ¶æ€æ˜¯fulfilledï¼Œä¼šç«‹å³è°ƒç”¨onFulfilled;
    // promiseçŠ¶æ€æ˜¯rejected, ä¼šç«‹å³è°ƒç”¨onRejected;
    if (this._state === FULFILLED) {
        realOnFulfilled(this._value)
    }

    if (this._state === REJECTED) {
        realOnRejected(this._reason)
    }
}

// æµ‹è¯•
let promise = new MyPromise((resolve, reject) => {
   resolve(111)
}).then((res) => {
    console.log(res); // 111
})

let promise = new MyPromise((resolve, reject) => {
    reject("æˆ‘é”™äº†")
}).then(null, (err) => {
    console.log(err); // æˆ‘é”™äº†
})
```

å¯ä»¥çœ‹åˆ°ï¼ŒåŸºæœ¬å®žçŽ°äº†æœ€ç®€å•çš„promiseï¼Œåœ¨æž„é€ å‡½æ•°ä¸­resolveå’Œrejectæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å®žä¾‹çš„thenæ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°æ‹¿åˆ°promiseå®žä¾‹ä¸­resolveçš„å€¼ï¼›åœ¨ç¬¬äºŒä¸ªå‚æ•°ä¸­æ‹¿åˆ°promiseå®žä¾‹ä¸­rejectçš„åŽŸå› ã€‚

ä½†æ˜¯å‚è€ƒè§„èŒƒä¸­thenæ–¹æ³•çš„è¡Œä¸ºï¼Œæˆ‘ä»¬è¿™é‡Œçš„å®žçŽ°æ˜¯è¿œè¿œè¾¾ä¸åˆ°æ ‡å‡†çš„,æˆ‘ä»¬å°†thenæ–¹æ³•çš„è¡Œä¸ºç½—åˆ—ä¸‹:

#### 1.thenæ–¹æ³•çš„ä¸¤ä¸ªå‚æ•°

> - thenæ–¹æ³•çš„ä¸¤ä¸ªå‚æ•°onFulfilledå’ŒonRejectedï¼Œå¦‚æžœå…¶å€¼ä¸æ˜¯å‡½æ•°æ—¶ï¼Œå…¶å€¼å¿…é¡»è¢«å¿½ç•¥

å¯¹äºŽonFulfilledçš„ç‰¹æ€§(onFulfilledæ˜¯å‡½æ•°)

> - promiseä¸ºresolve(stateæ˜¯fulFilled)æ—¶è°ƒç”¨onFulfilledï¼ŒonFulfilledçš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºresolveä¼ å…¥çš„å€¼ã€‚
> - åœ¨promiseçŠ¶æ€æ”¹å˜å‰ä¸å¯è°ƒç”¨
> - è°ƒç”¨æ¬¡æ•°ä¸èƒ½è¶…è¿‡ä¸€æ¬¡

å¯¹äºŽonRejectedçš„ç‰¹æ€§(onRejectedæ˜¯å‡½æ•°)

> - promiseä¸ºreject(stateæ˜¯rejected)æ—¶è°ƒç”¨onFulfilledï¼ŒonRejectedçš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºrejectä¼ å…¥çš„å€¼ã€‚
> - åœ¨promiseçŠ¶æ€æ”¹å˜å‰ä¸å¯è°ƒç”¨
> - è°ƒç”¨æ¬¡æ•°ä¸èƒ½è¶…è¿‡ä¸€æ¬¡

#### 2.thenæ–¹æ³•å¯ä»¥è¢«åŒä¸€ä¸ªpromiseå¯¹è±¡è°ƒç”¨å¤šæ¬¡

> - å½“ `promise` æˆåŠŸçŠ¶æ€æ—¶ï¼Œæ‰€æœ‰ `onFulfilled` éœ€æŒ‰ç…§å…¶æ³¨å†Œé¡ºåºä¾æ¬¡å›žè°ƒ
> - å½“ `promise` å¤±è´¥çŠ¶æ€æ—¶ï¼Œæ‰€æœ‰ `onRejected` éœ€æŒ‰ç…§å…¶æ³¨å†Œé¡ºåºä¾æ¬¡å›žè°ƒ

#### 3.è¿”å›žå€¼

> thenæ–¹æ³•è¿”å›žä¸€ä¸ªpromiseå¯¹è±¡

æ‰€ä»¥promiseæ”¯æŒé“¾å¼è°ƒç”¨

```js
promise1.then(onFulfilled1, onRejected1).then(onFulfilled2, onRejected2);
```

è¿™é‡Œé“¾å¼è°ƒç”¨è§„èŒƒä¹Ÿå®šä¹‰äº†å„ç§æƒ…å†µä¸‹çš„è¡Œä¸ºè§„èŒƒ,å…¶å®žä¸»è¦æ˜¯**å€¼çš„ä¼ é€’å’Œé”™è¯¯çš„æ•èŽ·æœºåˆ¶**:

 å¦‚æžœ `onFulfilled` æˆ–è€… `onRejected` è¿”å›žä¸€ä¸ªå€¼ `x` ï¼Œåˆ™è¿è¡Œä¸‹é¢çš„ `Promise` è§£å†³è¿‡ç¨‹ï¼š`[[Resolve]](promise2, x)`

> - è‹¥ `x` ä¸ä¸º `Promise` ï¼Œåˆ™ä½¿ `x` ç›´æŽ¥ä½œä¸ºæ–°è¿”å›žçš„ `Promise` å¯¹è±¡çš„å€¼ï¼Œ å³æ–°çš„`onFulfilled` æˆ–è€… `onRejected` å‡½æ•°çš„å‚æ•°.
> - è‹¥ `x` ä¸º `Promise` ï¼Œè¿™æ—¶åŽä¸€ä¸ªå›žè°ƒå‡½æ•°ï¼Œå°±ä¼šç­‰å¾…è¯¥ `Promise` å¯¹è±¡(å³ `x` )çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œæ‰ä¼šè¢«è°ƒç”¨ï¼Œå¹¶ä¸”æ–°çš„ `Promise` çŠ¶æ€å’Œ `x` çš„çŠ¶æ€ç›¸åŒã€‚

```js
// è¿™é‡Œå°±æ˜¯è¿”å›žäº†ä¸€ä¸ªå€¼ï¼Œæ‰€ä»¥promise1ä¼šå°†è¿™ä¸ªå€¼ä¼ é€’ç»™promise2çš„thenæ–¹æ³•
let promise1 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve()
  }, 1000)
})
promise2 = promise1.then(res => {
  // è¿”å›žä¸€ä¸ªæ™®é€šå€¼
  return 'è¿™é‡Œè¿”å›žä¸€ä¸ªæ™®é€šå€¼'
})
promise2.then(res => {
  console.log(res) //1ç§’åŽæ‰“å°å‡ºï¼šè¿™é‡Œè¿”å›žä¸€ä¸ªæ™®é€šå€¼
})
```

å†æ¥çœ‹è¿™ä¸ªä¾‹å­ï¼š

```js
// è¿™é‡Œæ˜¯è¿”å›žäº†ä¸€ä¸ªpromise,promise2ä¼šç­‰å¾…promise1å’Œthenæ–¹æ³•ä¸­çš„å›žè°ƒå‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œå¹¶ä¸”æ‹¿åˆ°promise1çš„æ‰§è¡Œç»“æžœä½œä¸ºthenæ–¹æ³•å›žè°ƒå‡½æ•°çš„å‚æ•°
let promise1 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve()
  }, 1000)
})
promise2 = promise1.then(res => {
  // è¿”å›žä¸€ä¸ªPromiseå¯¹è±¡
  return new Promise((resolve, reject) => {
    setTimeout(() => {
     resolve('è¿™é‡Œè¿”å›žä¸€ä¸ªPromise')
    }, 2000)
  })
})
promise2.then(res => {
  console.log(res) //3ç§’åŽæ‰“å°å‡ºï¼šè¿™é‡Œè¿”å›žä¸€ä¸ªPromise
})
```

 å¦‚æžœ `onFulfilled` æˆ–è€… `onRejected` æŠ›å‡ºå¼‚å¸¸`e`,é‚£ä¸ªpromise2çš„çŠ¶æ€å¿…é¡»ä¸º`rejected`,å¹¶ä¸”è¿”å›žeï¼Œä¾‹å¦‚ï¼š

```js
let promise1 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('success')
  }, 1000)
})
promise2 = promise1.then(res => {
  throw new Error('è¿™é‡ŒæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸e')
})
promise2.then(res => {
  console.log(res)
}, err => {
  console.log(err) //1ç§’åŽæ‰“å°å‡ºï¼šè¿™é‡ŒæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸e
})
```

å¦‚æžœ`onFulfilled` ä¸æ˜¯å‡½æ•°ä¸” `promise1` çŠ¶æ€ä¸ºæˆåŠŸ`ï¼ˆFulfilledï¼‰`ï¼Œ `promise2` å¿…é¡»å˜ä¸ºæˆåŠŸ`ï¼ˆFulfilledï¼‰`å¹¶è¿”å›ž `promise1` æˆåŠŸçš„å€¼ï¼Œä¾‹å¦‚ï¼š

```js
let promise1 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('success')
  }, 1000)
})
promise2 = promise1.then('è¿™é‡Œçš„onFulfilledæœ¬æ¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä½†çŽ°åœ¨ä¸æ˜¯')
promise2.then(res => {
  console.log(res) // 1ç§’åŽæ‰“å°å‡ºï¼šsuccess
}, err => {
  console.log(err)
})
```

 å¦‚æžœ `onRejected` ä¸æ˜¯å‡½æ•°ä¸” `promise1` çŠ¶æ€ä¸ºå¤±è´¥`ï¼ˆRejectedï¼‰`ï¼Œ`promise2`å¿…é¡»å˜ä¸ºå¤±è´¥`ï¼ˆRejectedï¼‰` å¹¶è¿”å›ž `promise1` å¤±è´¥çš„å€¼ï¼Œä¾‹å¦‚ï¼š

```js
let promise1 = new Promise((resolve, reject) => {
  setTimeout(() => {
    reject('fail')
  }, 1000)
})
promise2 = promise1.then(res => res, 'è¿™é‡Œçš„onRejectedæœ¬æ¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä½†çŽ°åœ¨ä¸æ˜¯')
promise2.then(res => {
  console.log(res)
}, err => {
  console.log(err)  // 1ç§’åŽæ‰“å°å‡ºï¼šfail
})
```

æˆ‘ä»¬éœ€è¦å®Œå–„ä¸‹æˆ‘ä»¬çš„thenæ–¹æ³•,é¦–å…ˆä½¿ç”¨æ•°ç»„å­˜å‚¨æˆ‘ä»¬çš„`onFulfilled`å’Œ`onRejected`ä¸¤ä¸ªå›žè°ƒå‡½æ•°ï¼Œå› ä¸ºå¯èƒ½å­˜åœ¨å¤šä¸ª`onFulfilled`å’Œ`onRejected`ï¼š

```js
// constructoræž„é€ å‡½æ•°ä¸­æ·»åŠ 
constructor(executor) {
    if (!isFunction(executor)) {
      return new Error("å¤§å…„å¼Ÿï¼Œä¼ å…¥çš„ä¸æ˜¯å‡½æ•°ï¼ï¼")
    }

    this._state = PENDING; // åˆå§‹çŠ¶æ€
    this._value = null; //æˆåŠŸè¿”å›žçš„å€¼
    this._reason = null; //å¤±è´¥è¿”å›žçš„åŽŸå› ï¼Œ
    this._onFulfilledCallbacks = []  // å­˜å‚¨é“¾å¼è°ƒç”¨æ—¶æˆåŠŸçš„å‡½æ•°
    this._onRejectedCallbacks = []  // å­˜å‚¨é“¾å¼è°ƒç”¨å¤±è´¥çš„å‡½æ•°

    try {
      // æž„é€ å‡½æ•°æ‰§è¡Œå®Œæˆï¼Œç«‹å³æ‰§è¡Œexecutorå‡½æ•°(æ³¨æ„ï¼Œéœ€è¦ä½¿ç”¨bindç»‘å®šthisçš„ä¸Šä¸‹æ–‡)
      executor(this._resolve.bind(this), this._reject.bind(this))
    } catch (err) {
      this._reject(err)
    }
}
```

é‡æ–°å®šä¹‰thenæ–¹æ³•

```js
MyPromise.prototype.then = function(onFulfilled, onRejected) {
    const {_state, _value} = this;
    
    return new MyPromise((onFulfilledNext, onRejectedNext) => {
        // æ ¹æ®thenæ–¹æ³•çš„ä¼ å€¼ç­–ç•¥å’Œæ•èŽ·å¼‚å¸¸çš„è§„èŒƒï¼Œå®šä¹‰handleFulfilledå’ŒhandleRejectedå‡½æ•°
        let handleFulfilled = _value => {
            try {
                if (!isFunction(onFulfilled)) {
                    onFulfilledNext(_value)
                } else {
                    let res = onFulfilled(_value);
                    if (res instanceof MyPromise) {
                        // å¦‚æžœå½“å‰å›žè°ƒå‡½æ•°è¿”å›žçš„æ˜¯promiseå¯¹è±¡ï¼Œéœ€è¦ç­‰å¾…å…¶æ‰§è¡Œå®Œæ¯•ï¼Œå†è¿›è¡Œä¸‹ä¸€æ¬¡å›žè°ƒ
                        res.then(onFulfilledNext, onRejectedNext)
                    } else {
                        // å¦åˆ™ï¼Œå°†ç»“æžœä¼ é€’ç»™ä¸‹ä¸€æ¬¡å›žè°ƒå‡½æ•°
                        onFulfilledNext(res)
                    }
                }
            } catch (err) {
                onRejectedNext(err)
            }
        }

        let handleRejected = error => {
            try {
                if (!isFunction(onRejected)) {
                    onRejectedNext(error)
                } else {
                    let res = onRejected(error);
                    if (res instanceof MyPromise) {
                        // å¦‚æžœå½“å‰å›žè°ƒå‡½æ•°è¿”å›žçš„æ˜¯promiseå¯¹è±¡ï¼Œéœ€è¦ç­‰å¾…å…¶æ‰§è¡Œå®Œæ¯•ï¼Œå†è¿›è¡Œä¸‹ä¸€æ¬¡å›žè°ƒ
                        res.then(onFulfilledNext, onRejectedNext)
                    } else {
                        // å¦åˆ™ï¼Œå°†ç»“æžœä¼ é€’ç»™ä¸‹ä¸€æ¬¡å›žè°ƒå‡½æ•°
                        onFulfilledNext(res)
                    }
                }
            } catch (err) {
                onRejectedNext(err)
            }
        }

        switch (_state) {
            case FULFILLED:
                onFulfilled(_value)
                break;
            case REJECTED:
                onRejected(_value)
                break;
            case PENDING:
                this._onFulfilledCallbacks.push(handleFulfilled)
                this._onRejectedCallbacks.push(handleRejected)
                break;
        }
    })
} 
```

è¿™é‡Œæ€»ç®—æ˜¯å¯¹å€¼çš„ä¼ é€’å’Œé”™è¯¯çš„å¤„ç†åšäº†è§„èŒƒåŒ–ï¼Œå¹¶ä¸”æ”¶é›†å¥½äº†`handleFulfilled`å’Œ`handleRejected`ï¼ŒæŽ¥ç€æˆ‘ä»¬éœ€è¦ä¾æ¬¡å–å‡ºæ•°ç»„ä¸­çš„å‡½æ•°å¹¶æ‰§è¡Œï¼š

```js
// resolveå‡½æ•°
    _resolve (val) {
        if (this._state !== PENDING) return;
        // ä¾æ¬¡å–å‡ºæ•°ç»„ä¸­çš„å‡½æ•°æ‰§è¡Œå¹¶æ¸…ç©ºæ•°ç»„
        const run = () => {
            this._state = FULFILLED;
            this._value = val;
            let cb;

            while(this._onFulfilledCallbacks.shift()) {
                cb(val)
            }
        }
        // ä¸ºäº†æ”¯æŒåŒæ­¥çš„promise,è¿™é‡Œå¼‚æ­¥è°ƒç”¨
        setTimeout(() => run(), 0)
    }

    //  rejectå‡½æ•°
    _reject (err) {
        if (this._state !== PENDING) return;

        const run = () => {
            this._state = REJECTED;
            this._value = err;

            let cb;

            while(this._onRejectedCallbacks.shift()) {
                cb(err)
            }
        }

        setTimeout(() => run(), 0)
       
    }
```

æœ€åŽå¢žåŠ ä¸€äº›å®žä¾‹æ–¹æ³•å’Œé™æ€æ–¹æ³•ï¼š

```js
 // æ·»åŠ catchæ–¹æ³•
    catch (onRejected) {
        return this.then(undefined, onRejected)
    }
    
    // æ·»åŠ resolveæ–¹æ³•
    static resolve (value) {
        if (value instanceof MyPromise) return value;
        return new MyPromise(resolve => resolve(value))
    }

    // æ·»åŠ é™æ€rejectæ–¹æ³•
    static reject (value) {
        return new MyPromise((resolve, reject) => reject(value))
    }
```

### ä¸‰ã€promiseçš„å®Œæ•´å®žçŽ°

```js
// å®žçŽ°ç®€å•çš„promise

// å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼šåˆ¤æ–­ä¼ å…¥çš„å˜é‡æ˜¯å¦æ˜¯å‡½æ•°
const isFunction = variable => typeof variable === 'function';

// å®šä¹‰Promiseçš„ä¸‰ç§çŠ¶æ€: pendingã€fulfilledã€rejected

const PENDING = 'pending'
const FULFILLED = 'fulfilled'
const REJECTED = 'rejected'

// å®šä¹‰ä¸€ä¸ªè‡ªå·±çš„Promiseç±»
class MyPromise {
    constructor(executor) {
        if (!isFunction(executor)) {
            return new Error("å¤§å…„å¼Ÿï¼Œä¼ å…¥çš„ä¸æ˜¯å‡½æ•°ï¼ï¼")
        }

        this._state = PENDING;
        this._value = null; //æˆåŠŸè¿”å›žçš„å€¼
        this._onFulfilledCallbacks = [] // å­˜å‚¨é“¾å¼è°ƒç”¨æ—¶æˆåŠŸçš„å‡½æ•°
        this._onRejectedCallbacks = [] // å­˜å‚¨é“¾å¼è°ƒç”¨å¤±è´¥çš„å‡½æ•°

        try {
            executor(this._resolve.bind(this), this._reject.bind(this))
        } catch (err) {
           this._reject(err)
        }
    }

    // executorçš„ç¬¬ä¸€ä¸ªå‚æ•° resolveæ–¹æ³•
    _resolve (val) {
        if (this._state !== PENDING) return;
        // ä¾æ¬¡å–å‡ºæ•°ç»„ä¸­çš„å‡½æ•°æ‰§è¡Œå¹¶æ¸…ç©ºæ•°ç»„
        const run = () => {
            this._state = FULFILLED;
            this._value = val;
            let cb;

            while(cb = this._onFulfilledCallbacks.shift()) {
                cb(val)
            }
        }
        // ä¸ºäº†æ”¯æŒåŒæ­¥çš„promise,è¿™é‡Œå¼‚æ­¥è°ƒç”¨
        setTimeout(() => run(), 0)
    }

    //  executorçš„ç¬¬äºŒä¸ªå‚æ•° rejectæ–¹æ³•
    _reject (err) {
        if (this._state !== PENDING) return;

        const run = () => {
            this._state = REJECTED;
            this._value = err;

            let cb;

            while(cb = this._onRejectedCallbacks.shift()) {
                cb(err)
            }
        }

        setTimeout(() => run(), 0)
       
    }

    // å®žçŽ°thenæ–¹æ³•
    then (onFulfilled, onRejected) {
        const {_state, _value} = this;
    
        return new MyPromise((onFulfilledNext, onRejectedNext) => {
            // æ ¹æ®thenæ–¹æ³•çš„ä¼ å€¼ç­–ç•¥å’Œæ•èŽ·å¼‚å¸¸çš„è§„èŒƒï¼Œå®šä¹‰handleFulfilledå’ŒhandleRejectedå‡½æ•°
            let handleFulfilled = _value => {
                try {
                    if (!isFunction(onFulfilled)) {
                        onFulfilledNext(_value)
                    } else {
                        let res = onFulfilled(_value);
                        if (res instanceof MyPromise) {
                            // å¦‚æžœå½“å‰å›žè°ƒå‡½æ•°è¿”å›žçš„æ˜¯promiseå¯¹è±¡ï¼Œéœ€è¦ç­‰å¾…å…¶æ‰§è¡Œå®Œæ¯•ï¼Œå†è¿›è¡Œä¸‹ä¸€æ¬¡å›žè°ƒ
                            res.then(onFulfilledNext, onRejectedNext)
                        } else {
                            // å¦åˆ™ï¼Œå°†ç»“æžœä¼ é€’ç»™ä¸‹ä¸€æ¬¡å›žè°ƒå‡½æ•°
                            onFulfilledNext(res)
                        }
                    }
                } catch (err) {
                    onRejectedNext(err)
                }
            }

            let handleRejected = error => {
                try {
                    if (!isFunction(onRejected)) {
                        onRejectedNext(error)
                    } else {
                        let res = onRejected(error);
                        if (res instanceof MyPromise) {
                            // å¦‚æžœå½“å‰å›žè°ƒå‡½æ•°è¿”å›žçš„æ˜¯promiseå¯¹è±¡ï¼Œéœ€è¦ç­‰å¾…å…¶æ‰§è¡Œå®Œæ¯•ï¼Œå†è¿›è¡Œä¸‹ä¸€æ¬¡å›žè°ƒ
                            res.then(onFulfilledNext, onRejectedNext)
                        } else {
                            // å¦åˆ™ï¼Œå°†ç»“æžœä¼ é€’ç»™ä¸‹ä¸€æ¬¡å›žè°ƒå‡½æ•°
                            onFulfilledNext(res)
                        }
                    }
                } catch (err) {
                    onRejectedNext(err)
                }
            }

            switch (_state) {
                case FULFILLED:
                    onFulfilled(_value)
                    break;
                case REJECTED:
                    onRejected(_value)
                    break;
                case PENDING:
                    this._onFulfilledCallbacks.push(handleFulfilled)
                    this._onRejectedCallbacks.push(handleRejected)
                    break;
            }
        })
    }

    // æ·»åŠ catchæ–¹æ³•
    catch (onRejected) {
        return this.then(undefined, onRejected)
    }
    
    // æ·»åŠ resolveæ–¹æ³•
    static resolve (value) {
        if (value instanceof MyPromise) return value;
        return new MyPromise(resolve => resolve(value))
    }

    // æ·»åŠ é™æ€rejectæ–¹æ³•
    static reject (value) {
        return new MyPromise((resolve, reject) => reject(value))
    }
}
```

è¿™é‡Œç”±äºŽè‡ªå·±å¯¹promiseçš„ä½¿ç”¨è¿˜ä¸æ˜¯ç‰¹åˆ«ç†Ÿæ‚‰ï¼Œæ‰€ä»¥è¿™é‡Œçš„å®žçŽ°å…¶å®žæ˜¯å›«å›µåžæž£ï¼ŒåŸºæœ¬æ˜¯å€Ÿé‰´äº†[promiseå®žçŽ°åŽŸç†(é™„æºç )](https://juejin.im/post/6844903665686282253#heading-2s://juejin.im/post/6844903665686282253#heading-2)çš„å®žçŽ°ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€äº›åœ°æ–¹æ²¡æœ‰ç†è§£ï¼Œpromiseä½¿ç”¨æ›´åŠ ç†Ÿç»ƒåŽä¼šå¯¹promiseçš„å®žçŽ°åŽŸç†ç†è§£æ›´åŠ æ·±åˆ»ã€‚è¿™ç¯‡æ–‡ç« ä½œè€…è®²è§£çš„å¾ˆé€å½»ï¼Œæœ‰æ—¶é—´å¯ä»¥çœ‹ä¸‹ï¼Œä½†æ˜¯è¿™é‡Œåšçš„åšçš„ç¬”è®°å¯¹promiseçš„ç†è§£ä¹Ÿæ˜¯å¾ˆæœ‰ç”¨çš„ã€‚

### å››ã€promisify 

>  promisify æ˜¯æŒ‡å°†å…·æœ‰å¼‚æ­¥æ“ä½œçš„è¡Œä¸ºpromiseåŒ–ï¼Œå› ä¸ºpromiseç¡®å®žå¾ˆé€‚åˆå¹²è¿™ä¸ª

å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š

```js
function loadScript(src, callback) {
  let script = document.createElement('script');
  script.src = src;

  script.onload = () => callback(null, script);
  script.onerror = () => callback(new Error(`Script load error for ${src}`));

  document.head.append(script);
}

// ç”¨æ³•ï¼š
// loadScript('path/script.js', (err, script) => {...})
```

ä¸ºäº†å¯è¯»æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å°†loadScript promiseåŒ–ï¼š

```js
let loadPromise = function (src) {
  return new Promise((resolve, reject) => {
    loadScript(src, (err,script) => {
      if (err) reject(err);
      else resolve(script)
    })
  })
}
```
